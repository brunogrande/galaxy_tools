<tool id="factera" name="FACTERA" version="1.4.3">
	
	<description>Fusion And Chromosomal Translocation Enumeration and Recovery Algorithm</description>

	<requirements>
		<requirement type="package" version="0.1.19">samtools</requirement>
		<requirement type="package" version="2.2.26+">blast+</requirement>
		<requirement type="package" version="310">ucsc_user_apps</requirement>
		<requirement type="package" version="5.18.1">perl</requirement>
		<requirement type="package" version="1.4.3">factera</requirement>
		<requirement type="package" version="3.0608">perl_descriptive_statistics</requirement>
		<requirement type="set_environment">FACTERA_DIR</requirement>
	</requirements> 

	<command>		
	<!-- Run commands using Galaxy perl -->
		
	ln -s $sortedBam ./input.bam;
	ln -s $sortedBam.metadata.bam_index ./input.bam.bai;

	#if $cond.additionalOpt == "no"
		perl \$FACTERA_DIR/factera-v1.4.3.pl -F -o ./ input.bam $exonBed $genome2Bit
		#if $targetBed
			$targetBed
		#end if
		;
	#else
		perl \$FACTERA_DIR/factera-v1.4.3.pl -F -r $cond.r -m $cond.m -x $cond.x -s $cond.s -f $cond.f -S $cond.S 
		-k $cond.k -c $cond.c -b $cond.b -p $cond.p -a $cond.a -o ./ input.bam $exonBed $genome2Bit;
		#if $targetBed
			$targetBed
		#end if
	#end if

	<!-- Keep only the files specified -->
	#if $outputOpts.parameters_txt
		cat *parameters.txt &gt; $parameters_txt;
	#end if
	#if $outputOpts.discordantpair_depth_txt
		cat *discordantpair.depth.txt &gt; $discordantpair_depth_txt;
	#end if
	#if $outputOpts.discordantpair_details_txt
		cat *discordantpair.details.txt &gt; $discordantpair_details_txt;
	#end if
	#if $outputOpts.fusionstargets_bed
		cat *fusiontargets.bed &gt; $fusionstargets_bed;
	#end if
	#if $outputOpts.blastreads_fa
		cat *blastreads.fa &gt; $blastreads_fa;
	#end if
	#if $outputOpts.blastquery_fa
		cat *blastquery.fa &gt; $blastquery_fa;
	#end if
	#if $outputOpts.fusionseqs_fa
		cat *fusionseqs.fa &gt; $fusionseqs_fa;
	#end if
	#if $outputOpts.fusions_bed
		cat *fusions.bed &gt; $fusions_bed;
	#end if
	#if $outputOpts.fusions_txt
		cat *fusions.txt &gt; $fusions_txt;
	#end if
	</command>
 
	<inputs>
		<param type="data" format="bam" name="sortedBam" label="Alignment in BAM format" help="Alignment must be sorted by position" />
		<param type="data" format="bed" name="exonBed" label="Genomic coordinates with gene/exon names in fourth column" />		
		<param type="data" format="twobit" name="genome2Bit" label="Two bit reference sequence" />	
		<param type="data" format="bed" name="targetBed" optional="True" label="Target BED file" help="3-column BED (chr,start,end) specfying specific genomic regions of interest"/>
		<param type="select" multiple="true" display="checkboxes" name="outputOpts" label="Specify Desired Output Files to Store:">
			<option value="parameters_txt">parameters.txt</option>
			<option value="discordantpair_depth_txt">discordantpair.depth.txt</option>
			<option value="discordantpair_details_txt">discordantpair.details.txt</option>
			<option value="fusionstarget_bed">fusiontargets.bed</option>
			<option value="blastreads_fa">blastreads.fa</option>
			<option value="blastquery_fa">blastquery.fa</option>
			<option value="fusionseqs_fa">fusionseqs.fa</option>
			<option value="fusion_bed">fusions.bed</option>
			<option value="fusion_txt" selected="True">fusions.txt</option>
		</param>		
		<conditional name="cond">
			<param type="select" name="additionalOpt" label="Additional Options">
				<option value="yes">Yes</option>
				<option value="no" selected="True">No</option>
			</param>
			<when value="yes"> 
				<!-- Names follow command line flags in factera.pl -->
				<param type="integer" name="r" label="Minimum number of breakpoint-scanning reads required for output" value="5"/>
				<param type="integer" name="m" label="Minimum number of discordant reads required for each candidate fusion" value="2"/>
				<param type="integer" name="x" label="Maximum number of breakpoints to examine for each pair of genomic regions" value="5"/> 
				<param type="integer" name="s" label="Minimum number of reads with the same breakpoint" value="1"/>
				<param type="float" name="f" min="0" max="1" label="Minimum fraction of read bases required for alignment to fusion template" value=".9"/>
				<param type="float" name="S" min="0" max="1" label="Minimum similarity required for read to match fusion template" value=".95"/>
				<param type="integer" name="k" label="K-mer size (number of bases) for fragment comparison" value="10"/>
				<param type="integer" name="c" label="Minimum size of soft-clipped region to consider" value="16"/>
				<param type="integer" name="b" label="Number of bases flanking breakpoint for fusion template" value="500"/>
				<param type="integer" name="p" label="Number of threads for blastn search" value="4"/>
				<param type="integer" name="a" label="Number of bases flanking breakpoint to provide in output" value="50"/>
			</when>		
		</conditional>
	</inputs>	
  
	<outputs>
		<data format="txt" name="parameters_txt">	
			<filter>outputOpts == "parameters_txt"</filter>
		</data>
		<data format="txt" name="discordantpair_depth_txt">	
			<filter>outputOpts == "discordantpair_depth_txt"</filter>
		</data>
		<data format="txt" name="discordantpair_details_txt">	
			<filter>outputOpts == "discordantpair_details_txt"</filter>
		</data>
		<data format="bed" name="fusionstarget_bed">	
			<filter>outputOpts == "fusionstarget_bed"</filter>
		</data>
		<data format="fasta" name="blastreads_fa">	
			<filter>outputOpts == "blastreads_fa"</filter>
		</data>
		<data format="fasta" name="blastquery_fa">	
			<filter>outputOpts == "blastquery_fa"</filter>
		</data>
		<data format="fasta" name="fusionseqs_fa">	
			<filter>outputOpts == "fusionseqs_fa"</filter>
		</data>
		<data format="bed" name="fusion_bed">	
			<filter>outputOpts == "fusion_bed"</filter>
		</data>
		<data format="txt" name="fusion_txt">	
			<filter>outputOpts == "fusion_txt"</filter>
		</data>
	</outputs>
  
	<help>This tool does Factera</help>

</tool>
